##############################################################################
#
#  xad-forge CI Workflow
#
#  Tests xad-forge across platforms. Uses Forge C API for binary compatibility
#  across different compilers.
#
#  Forge is built fresh in each job to ensure matching system libraries.
#
#  Copyright (c) 2025 The xad-forge Authors
#  SPDX-License-Identifier: Zlib
#
##############################################################################

name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  ##############################################################################
  # Windows
  ##############################################################################
  windows:
    strategy:
      fail-fast: false
      matrix:
        toolset: ["14.2", "14.4"]
        compiler: [msvc]
        standard: ["11", "17"]
        runtime: [dynamic, static]
        include:
          - compiler: msvc
            cxx: cl
            cc: cl
          - toolset: "14.4"
            compiler: clang
            standard: "11"
            runtime: dynamic
            cxx: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
            cc: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
          - toolset: "14.4"
            compiler: clang
            standard: "11"
            runtime: static
            cxx: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
            cc: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
          - toolset: "14.4"
            compiler: clang
            standard: "17"
            runtime: dynamic
            cxx: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
            cc: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
          - toolset: "14.4"
            compiler: clang
            standard: "17"
            runtime: static
            cxx: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
            cc: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe

    runs-on: windows-2022
    name: Windows ${{ matrix.compiler }} ${{ matrix.toolset }} C++${{ matrix.standard }} ${{ matrix.runtime }}

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout XAD (xad-jit fork with JIT support)
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad

      - name: Checkout forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Setup
        run: choco install -y ninja

      - name: Build Forge C API
        shell: cmd
        run: |
          cd forge
          call "%VSVARSALL%" amd64 -vcvars_ver=${{ matrix.toolset }}
          cmake -B build -S api/c -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" ^
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" ^
            -DFORGE_CAPI_BUILD_TESTS=OFF ^
            -DFORGE_CAPI_USE_STATIC_RUNTIME=${{ matrix.runtime == 'static' && 'ON' || 'OFF' }} ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build XAD
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64 -vcvars_ver=${{ matrix.toolset }}
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" ^
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" ^
            -DCMAKE_CXX_STANDARD=${{ matrix.standard }} ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_ENABLE_TESTS=OFF ^
            -DXAD_STATIC_MSVC_RUNTIME=${{ matrix.runtime == 'static' && 'ON' || 'OFF' }} ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build --config Release
          cmake --install build --config Release

      - name: Build xad-forge
        shell: cmd
        run: |
          cd xad-forge
          call "%VSVARSALL%" amd64 -vcvars_ver=${{ matrix.toolset }}
          set PATH=%cd%\..\install\bin;%PATH%
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" ^
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" ^
            -DCMAKE_CXX_STANDARD=${{ matrix.standard }} ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DXAD_FORGE_BUILD_TESTS=ON ^
            -DXAD_FORGE_USE_CAPI=ON ^
            -DXAD_FORGE_USE_STATIC_RUNTIME=${{ matrix.runtime == 'static' && 'ON' || 'OFF' }}
          cmake --build build --config Release

      - name: Run Tests
        shell: cmd
        run: |
          cd xad-forge\build
          set PATH=%cd%\..\..\install\bin;%PATH%
          ctest --output-on-failure

  ##############################################################################
  # Linux - GCC
  ##############################################################################
  linux-gcc:
    strategy:
      fail-fast: false
      matrix:
        version: ["7", "8", "9", "10", "11", "12", "13", "14"]
        standard: ["11", "17"]
        exclude:
          # GCC 7 doesn't fully support C++17
          - version: "7"
            standard: "17"

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:${{ matrix.version }}
    name: Linux GCC ${{ matrix.version }} C++${{ matrix.standard }}

    steps:
      - name: Use debian archive repos
        if: matrix.version == '7' || matrix.version == '8'
        run: |
          set -e
          sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
          sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list
          sed -i 's|http://deb.debian.org/debian buster-updates|http://archive.debian.org/debian buster-updates|g' /etc/apt/sources.list
          echo 'Acquire::Check-Valid-Until "false";' | tee /etc/apt/apt.conf.d/99no-check-valid-until

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build build-essential cmake git

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout XAD (xad-jit fork with JIT support)
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad

      - name: Checkout forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Build Forge C API
        run: |
          INSTALL_DIR=$(pwd)/install
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-std=c++17" \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build XAD
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-std=c++${{ matrix.standard }}" \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-std=c++${{ matrix.standard }}" \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR \
            -DXAD_FORGE_BUILD_TESTS=ON \
            -DXAD_FORGE_USE_CAPI=ON
          cmake --build build

      - name: Run Tests
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge/build
          export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$LD_LIBRARY_PATH
          ctest --output-on-failure

  ##############################################################################
  # Linux - Clang
  ##############################################################################
  linux-clang:
    strategy:
      fail-fast: false
      matrix:
        version: ["11", "12", "13", "14", "15", "16", "17", "18"]
        standard: ["11", "17"]

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/clang:${{ matrix.version }}
    name: Linux Clang ${{ matrix.version }} C++${{ matrix.standard }}

    steps:
      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build build-essential cmake git

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout XAD (xad-jit fork with JIT support)
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad

      - name: Checkout forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Build Forge C API
        run: |
          INSTALL_DIR=$(pwd)/install
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_STANDARD=17 \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build XAD
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_STANDARD=${{ matrix.standard }} \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_STANDARD=${{ matrix.standard }} \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR \
            -DXAD_FORGE_BUILD_TESTS=ON \
            -DXAD_FORGE_USE_CAPI=ON
          cmake --build build

      - name: Run Tests
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge/build
          export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$LD_LIBRARY_PATH
          ctest --output-on-failure

  ##############################################################################
  # macOS (disabled in Forge - ARM not yet supported)
  # TODO: Re-enable when Forge adds ARM/NEON support
  ##############################################################################
  # macos:
  #   ...
