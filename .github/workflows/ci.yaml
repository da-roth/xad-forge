##############################################################################
#
#  xad-forge CI Workflow
#
#  Tests xad-forge with the C API backend across all platforms and compilers
#  that xad-jit supports with JIT enabled.
#
#  Forge C API is built once per platform using the same settings as Forge's
#  own CI (ubuntu-latest for Linux, windows-2022 with default MSVC for Windows).
#  This tests the binary compatibility that the C API provides.
#
#  Copyright (c) 2025 The xad-forge Authors
#  SPDX-License-Identifier: Zlib
#
##############################################################################

name: CI

on:
  push:
  pull_request:

jobs:
  ##############################################################################
  # Build Forge C API (matches Forge's ci-capi.yml settings)
  ##############################################################################
  build-forge-linux:
    name: Build Forge C API (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/forge-install
          cmake --build build
          cmake --install build

      - name: Upload Forge C API
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-linux
          path: forge-install/

  build-forge-windows:
    name: Build Forge C API (Windows)
    runs-on: windows-2022

    steps:
      - name: Checkout forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          path: forge

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        run: choco install ninja -y

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DFORGE_CAPI_BUILD_TESTS=OFF `
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/forge-install
          cmake --build build
          cmake --install build

      - name: Upload Forge C API
        uses: actions/upload-artifact@v4
        with:
          name: forge-capi-windows
          path: forge-install/

  ##############################################################################
  # Windows
  ##############################################################################
  windows:
    needs: build-forge-windows
    strategy:
      fail-fast: false
      matrix:
        include:
          - toolset: "14.2"
            compiler: msvc
            cxx: cl
            cc: cl
          - toolset: "14.4"
            compiler: msvc
            cxx: cl
            cc: cl
          - toolset: "14.4"
            compiler: clang
            cxx: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe
            cc: C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Tools/Llvm/x64/bin/clang-cl.exe

    runs-on: windows-2022
    name: Windows ${{ matrix.compiler }} ${{ matrix.toolset }}

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout xad-jit
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad-jit

      - name: Download Forge C API
        uses: actions/download-artifact@v4
        with:
          name: forge-capi-windows
          path: install/

      - name: Setup
        run: choco install -y ninja

      - name: Debug paths
        shell: cmd
        run: |
          echo PWD=%cd%
          dir install\ 2>nul || echo install\ not found
          dir install\lib\cmake\ForgeCAPI\ 2>nul || echo ForgeCAPI cmake dir not found

      - name: Build XAD-JIT
        shell: cmd
        run: |
          cd xad-jit
          call "%VSVARSALL%" amd64 -vcvars_ver=${{ matrix.toolset }}
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" ^
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" ^
            -DCMAKE_CXX_STANDARD=11 ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_ENABLE_TESTS=OFF ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build --config Release
          cmake --install build --config Release

      - name: Build xad-forge
        shell: cmd
        run: |
          cd xad-forge
          call "%VSVARSALL%" amd64 -vcvars_ver=${{ matrix.toolset }}
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_COMPILER="${{ matrix.cxx }}" ^
            -DCMAKE_C_COMPILER="${{ matrix.cc }}" ^
            -DCMAKE_CXX_STANDARD=11 ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DXAD_FORGE_BUILD_TESTS=ON ^
            -DXAD_FORGE_USE_CAPI=ON
          cmake --build build --config Release

      - name: Run Tests
        shell: cmd
        run: |
          cd xad-forge\build
          set PATH=%cd%\..\..\install\bin;%PATH%
          ctest --output-on-failure

  ##############################################################################
  # Linux - GCC
  ##############################################################################
  linux-gcc:
    needs: build-forge-linux
    strategy:
      fail-fast: false
      matrix:
        version: ["7", "8", "9", "10", "11", "12", "13", "14"]

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:${{ matrix.version }}
    name: Linux GCC ${{ matrix.version }}

    steps:
      - name: Use debian archive repos
        if: matrix.version == '7' || matrix.version == '8'
        run: |
          set -e
          sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
          sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list
          sed -i 's|http://deb.debian.org/debian buster-updates|http://archive.debian.org/debian buster-updates|g' /etc/apt/sources.list
          echo 'Acquire::Check-Valid-Until "false";' | tee /etc/apt/apt.conf.d/99no-check-valid-until

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build build-essential cmake git

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout xad-jit
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad-jit

      - name: Download Forge C API
        uses: actions/download-artifact@v4
        with:
          name: forge-capi-linux
          path: install

      - name: Debug paths
        run: |
          echo "PWD=$(pwd)"
          ls -la install/ || echo "install/ not found"
          find install -name "*.cmake" 2>/dev/null || echo "No cmake files found"
          ls -la install/lib/cmake/ForgeCAPI/ 2>/dev/null || echo "ForgeCAPI cmake dir not found"

      - name: Build XAD-JIT
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-jit
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-std=c++11" \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-std=c++11" \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR \
            -DXAD_FORGE_BUILD_TESTS=ON \
            -DXAD_FORGE_USE_CAPI=ON
          cmake --build build

      - name: Run Tests
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge/build
          export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$LD_LIBRARY_PATH
          ctest --output-on-failure

  ##############################################################################
  # Linux - Clang
  ##############################################################################
  linux-clang:
    needs: build-forge-linux
    strategy:
      fail-fast: false
      matrix:
        version: ["11", "12", "13", "14", "15", "16", "17", "18"]

    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/clang:${{ matrix.version }}
    name: Linux Clang ${{ matrix.version }}

    steps:
      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build build-essential cmake git

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          path: xad-forge

      - name: Checkout xad-jit
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          path: xad-jit

      - name: Download Forge C API
        uses: actions/download-artifact@v4
        with:
          name: forge-capi-linux
          path: install

      - name: Debug paths
        run: |
          echo "PWD=$(pwd)"
          ls -la install/ || echo "install/ not found"
          find install -name "*.cmake" 2>/dev/null || echo "No cmake files found"
          ls -la install/lib/cmake/ForgeCAPI/ 2>/dev/null || echo "ForgeCAPI cmake dir not found"

      - name: Build XAD-JIT
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-jit
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_STANDARD=11 \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_STANDARD=11 \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR \
            -DXAD_FORGE_BUILD_TESTS=ON \
            -DXAD_FORGE_USE_CAPI=ON
          cmake --build build

      - name: Run Tests
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad-forge/build
          export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$LD_LIBRARY_PATH
          ctest --output-on-failure

  ##############################################################################
  # macOS (disabled in Forge - ARM not yet supported)
  # TODO: Re-enable when Forge adds ARM/NEON support
  ##############################################################################
  # macos:
  #   ...
